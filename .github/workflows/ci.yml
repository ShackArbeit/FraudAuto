name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'apps/webs/**'
            backend:
              - 'apps/api/**'
            infra:
              - '.github/workflows/**'
              - 'turbo.json'
              - 'pnpm-workspace.yaml'
              - 'pnpm-lock.yaml'
              - 'package.json'

      - name: Summary
        run: |
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Backend changed:  ${{ steps.filter.outputs.backend }}"
          echo "Infra changed:    ${{ steps.filter.outputs.infra }}"

  frontend_linux:
    name: Frontend (Linux) - lint & build
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true' }}
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint (webs)
        run: pnpm --filter webs run lint

      - name: Build (webs)
        run: pnpm --filter webs run build

  backend_linux:
    name: Backend (Linux) - install & import check
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true' }}
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies (apps/api)
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt

      - name: FastAPI import sanity check
        working-directory: apps/api
        run: |
          python -c "from main import app; print('FastAPI app import OK')"

  windows_smoke:
    name: Windows smoke (dev parity)
    runs-on: windows-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true' }}
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Frontend build smoke (webs)
        if: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true' }}
        run: pnpm --filter webs build

      - name: Setup Python
        if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Backend import smoke (apps/api)
        if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt
          python -c "from apps.api.main import app; print('FastAPI app import OK (Windows)')"

  all:
    name: Overall result
    runs-on: ubuntu-latest
    needs: [frontend_linux, backend_linux, windows_smoke]
    if: always()
    steps:
      - name: Report
        run: |
          echo "Frontend (Linux): ${{ needs.frontend_linux.result }}"
          echo "Backend  (Linux): ${{ needs.backend_linux.result }}"
          echo "Windows smoke:    ${{ needs.windows_smoke.result }}"
